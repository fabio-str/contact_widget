var PageTextWidget = {
    position: 'bottom-right',
    welcome_message: 'Send me a line',
    formHtml: '<%= j render "form" %>',
    cssStyles: "<% asset_url('tailwind.css') %>",
    circleStyles: {
        backgroundColor: 'black',
        height: '50px',
        width: '50px',
        borderRadius: '50%',
        position: 'absolute',
        bottom: '10px',
        right: '10px',
        cursor: 'pointer'
    },

    init: function() {
        console.log('Widget initialized!');
        this.showIcon();
        this.plantCss();
    },

    plantCss: function() {
        let stylesheet = document.createElement('link');
        stylesheet.rel = 'stylesheet';
        stylesheet.href = this.cssStyles;
        document.head.append(stylesheet);
    },

    showForm: function() {
        document.body.insertAdjacentHTML('beforeend', this.formHtml);
        document.getElementById('new_message').addEventListener('submit', this.submitForm);
        document.getElementById('widget_cancel').addEventListener('click', this.hideForm);
        this.hideIcon();
        this.storeInfo();
    },

    hideForm: function() {
        document.getElementById('page_text_widget').remove();
        PageTextWidget.showIcon();
    },

    hideIcon: function() {
        document.getElementById('page_text_icon').remove();
    },

    showIcon: function() {
        let icon = document.createElement('span');
        icon.id = 'page_text_icon';
        icon.addEventListener('click', this.showForm.bind(this));
        Object.assign(icon.style, this.circleStyles);
        document.body.append(icon);
    },

    submitForm: function(e) {
        e.preventDefault();
        let form = e.target;
    
        fetch(form.action, {
          method: 'POST',
          body: new FormData(form)
        }).then((response) => {
          PageTextWidget.hideForm();
          var confirmationMessage = document.createElement('div');
          confirmationMessage.innerHTML = 'Your form has been submitted successfully!';
          confirmationMessage.classList.add('confirmation-notice');
          document.body.insertBefore(confirmationMessage, document.body.firstChild);
        })
    },

    storeInfo: function () {
        // Attach event listeners to the name and email form fields
        const message_name = document.getElementById("message_name");
        const message_email = document.getElementById("message_email");
    
        message_name.addEventListener("change", function () {
            // Save the name to localStorage on change
            localStorage.setItem("pageTextWidget-name", this.value);
        });
    
        message_email.addEventListener("change", function () {
            // Save the email to localStorage on change
            localStorage.setItem("pageTextWidget-email", this.value);
        });
    
        // Check if we have pre-saved values for the name and email fields
        const savedName = localStorage.getItem("pageTextWidget-name");
        const savedEmail = localStorage.getItem("pageTextWidget-email");
    
        if (savedName) {
            // Pre-fill the name field
            message_name.value = savedName;
        }
    
        if (savedEmail) {
            // Pre-fill the email field
            message_email.value = savedEmail;
        }
    }
}

PageTextWidget.init();